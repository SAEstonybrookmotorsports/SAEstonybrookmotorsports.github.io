---
// src/pages/team.astro (or wherever your Team page lives)
import { Picture } from "astro:assets";
import BaseLayout from '../layouts/BaseLayout.astro';
import { teamData, type TeamMember } from '../lib/teamData';
import '../styles/global.css';
import '../styles/team.css';
import linkedinIcon from '../assets/linkedin.svg';

// Group members by subsystem
const grouped = teamData.reduce<Record<string, TeamMember[]>>((acc, member) => {
  (acc[member.subsystem] ||= []).push(member);
  return acc;
}, {});

// Order for rendering
const order = [
  'Leadership',
  'Powertrain',
  'Chassis',
  'Suspension',
  'Electronics',
  'CNC',
  'Software',
  'Drivetrain',
  'Testing',
  'Treasurer',
  'Composites',
  'Brakes',
  'Transmission'
];
---

<BaseLayout pageClass="team">
  <!-- Hero -->
  <section class="hero" style="--hero-img: url('/images/team-hero.jpg')">
    <div class="hero-content">
      <h1 class="hero-title">Meet the Team</h1>
      <p class="hero-sub">The people behind the machine</p>
    </div>
  </section>

  <!-- Render in custom order -->
  {order.map((subsystem, idx) => {
    const members = grouped[subsystem];
    if (!members || members.length === 0) return null;

    // use explicit `lead` field (more reliable than string matching)
    const lead = members.find(m => m.lead);

    return (
      <>
        <section class="section team-section fade-in" id={subsystem.toLowerCase()}>
          <h2 class="section-heading">{subsystem}</h2>

          {lead && (
            <div class="subsystem-lead">
              <Picture src={lead.image} alt={lead.name} formats={["avif","webp","png"]} width={200} height={200} />
              <h3>{lead.name}</h3>
              <p class="role">{lead.role}</p>
              {lead.custom && <p class="member-custom">{lead.custom}</p>}
              {lead.linkedin && (
                <a href={lead.linkedin} class="linkedin-icon" target="_blank" rel="noopener">
                  <Picture src={linkedinIcon} alt="LinkedIn" formats={["svg"]} width={24} height={24} />
                </a>
              )}
              <p class="bio" data-clicks="0" data-funbio={lead.funBio ?? ''}>{lead.bio}</p>
            </div>
          )}

          <div class="members-grid">
            {members
              .filter(m => m !== lead)
              .map(m => (
                <div class="member">
                  <Picture src={m.image} alt={m.name} formats={["avif","webp","png"]} width={150} height={150} />
                  <p class="member-name">{m.name}</p>
                  {m.custom && <p class="member-custom">{m.custom}</p>}
                  {m.linkedin && (
                    <a href={m.linkedin} class="linkedin-icon" target="_blank" rel="noopener">
                      <Picture src={linkedinIcon} alt="LinkedIn" formats={["svg"]} width={24} height={24} />
                    </a>
                  )}
                  <p class="bio" data-clicks="0" data-funbio={m.funBio ?? ''}>{m.bio}</p>
                </div>
              ))}
          </div>
        </section>

        {idx < order.length - 1 && <hr class="section-divider" />}
      </>
    );
  })}

  <!-- Scroll & Easter-egg Script -->
  <script type="module">
    // Intersection observer for fade-in elements
    const io = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          e.target.classList.add('visible');
          io.unobserve(e.target);
        }
      });
    }, { threshold: 0.2 });

    document.querySelectorAll('.fade-in').forEach(el => io.observe(el));

    // Click-to-reveal funBio: increments counter, shows funBio on 5 clicks
    document.querySelectorAll('.bio').forEach(el => {
      el.addEventListener('click', () => {
        const clicks = (+el.dataset.clicks || 0) + 1;
        el.dataset.clicks = String(clicks);
        if (clicks === 5) {
          const fun = el.dataset.funbio;
          if (fun) el.textContent = fun;
        }
      });
    });
  </script>
</BaseLayout>
